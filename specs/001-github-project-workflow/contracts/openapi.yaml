openapi: 3.1.0
info:
  title: GitHub Project Workflow API
  description: API endpoints for AI-assisted GitHub issue creation and workflow management
  version: 1.0.0

servers:
  - url: http://localhost:8000/api/v1
    description: Local development server

paths:
  /chat/messages:
    post:
      summary: Send chat message (existing - extended)
      description: |
        Processes user messages. Extended to handle feature requests that trigger 
        AI recommendation generation with ISSUE_CREATE action type.
      operationId: sendMessage
      tags:
        - Chat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatMessageRequest'
      responses:
        '200':
          description: AI response with optional action
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatMessage'
        '400':
          description: Validation error (e.g., no project selected)
        '401':
          description: Not authenticated

  /workflow/recommendations/{recommendation_id}/confirm:
    post:
      summary: Confirm issue recommendation
      description: |
        Confirms an AI-generated issue recommendation, triggering:
        1. GitHub Issue creation (REST API)
        2. Project attachment (GraphQL API)
        3. Initial status set to "Backlog"
        4. Auto-transition to "Ready"
      operationId: confirmRecommendation
      tags:
        - Workflow
      parameters:
        - name: recommendation_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Issue created and workflow initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowResult'
        '404':
          description: Recommendation not found
        '409':
          description: Recommendation already processed
        '500':
          description: GitHub API error

  /workflow/recommendations/{recommendation_id}/reject:
    post:
      summary: Reject issue recommendation
      description: Marks the recommendation as rejected without creating an issue.
      operationId: rejectRecommendation
      tags:
        - Workflow
      parameters:
        - name: recommendation_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Recommendation rejected
        '404':
          description: Recommendation not found

  /workflow/config:
    get:
      summary: Get workflow configuration
      description: Returns current workflow configuration for the selected project.
      operationId: getWorkflowConfig
      tags:
        - Workflow
      responses:
        '200':
          description: Workflow configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowConfiguration'
        '404':
          description: No project selected

    put:
      summary: Update workflow configuration
      description: Updates workflow configuration (status column names, assignees, etc.)
      operationId: updateWorkflowConfig
      tags:
        - Workflow
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowConfigurationUpdate'
      responses:
        '200':
          description: Configuration updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowConfiguration'
        '400':
          description: Invalid configuration

  /workflow/transitions:
    get:
      summary: Get workflow transition history
      description: Returns audit log of recent workflow transitions for debugging/monitoring.
      operationId: getTransitions
      tags:
        - Workflow
      parameters:
        - name: issue_id
          in: query
          required: false
          schema:
            type: string
          description: Filter by issue ID
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: List of transitions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WorkflowTransition'

components:
  schemas:
    ChatMessageRequest:
      type: object
      required:
        - content
      properties:
        content:
          type: string
          description: User message content
          maxLength: 4000
          example: "I need a feature to allow users to export their data as CSV"

    ChatMessage:
      type: object
      properties:
        message_id:
          type: string
          format: uuid
        session_id:
          type: string
          format: uuid
        sender_type:
          type: string
          enum: [user, assistant, system]
        content:
          type: string
        action_type:
          type: string
          enum: [task_create, status_update, issue_create]
          nullable: true
        action_data:
          type: object
          nullable: true
          properties:
            recommendation_id:
              type: string
              format: uuid
            proposed_title:
              type: string
            user_story:
              type: string
            ui_ux_description:
              type: string
            functional_requirements:
              type: array
              items:
                type: string
            status:
              type: string
              enum: [pending, confirmed, rejected]
        timestamp:
          type: string
          format: date-time

    IssueRecommendation:
      type: object
      required:
        - recommendation_id
        - title
        - user_story
        - ui_ux_description
        - functional_requirements
        - status
      properties:
        recommendation_id:
          type: string
          format: uuid
        session_id:
          type: string
          format: uuid
        original_input:
          type: string
        title:
          type: string
          maxLength: 256
          example: "Add CSV export functionality for user data"
        user_story:
          type: string
          example: "As a user, I want to export my data as CSV so that I can analyze it in Excel."
        ui_ux_description:
          type: string
          example: "Add an 'Export' button in the user profile section. Show a loading indicator during export."
        functional_requirements:
          type: array
          items:
            type: string
          example:
            - "System MUST generate CSV with all user profile fields"
            - "Export MUST include timestamps in ISO 8601 format"
            - "System MUST handle exports up to 10MB"
        status:
          type: string
          enum: [pending, confirmed, rejected]
        created_at:
          type: string
          format: date-time
        confirmed_at:
          type: string
          format: date-time
          nullable: true

    WorkflowResult:
      type: object
      properties:
        success:
          type: boolean
        issue_id:
          type: string
          description: GitHub Issue node ID
        issue_number:
          type: integer
          description: Human-readable issue number
        issue_url:
          type: string
          format: uri
        project_item_id:
          type: string
          description: GitHub Project item ID
        current_status:
          type: string
          example: "Ready"
        message:
          type: string
          example: "Issue #42 created and added to project"

    WorkflowConfiguration:
      type: object
      properties:
        project_id:
          type: string
        repository_owner:
          type: string
        repository_name:
          type: string
        copilot_assignee:
          type: string
          default: "github-copilot"
        review_assignee:
          type: string
          nullable: true
          description: Defaults to repository owner if null
        status_backlog:
          type: string
          default: "Backlog"
        status_ready:
          type: string
          default: "Ready"
        status_in_progress:
          type: string
          default: "In Progress"
        status_in_review:
          type: string
          default: "In Review"
        enabled:
          type: boolean
          default: true

    WorkflowConfigurationUpdate:
      type: object
      properties:
        copilot_assignee:
          type: string
        review_assignee:
          type: string
        status_backlog:
          type: string
        status_ready:
          type: string
        status_in_progress:
          type: string
        status_in_review:
          type: string
        enabled:
          type: boolean

    WorkflowTransition:
      type: object
      properties:
        transition_id:
          type: string
          format: uuid
        issue_id:
          type: string
        project_id:
          type: string
        from_status:
          type: string
          nullable: true
        to_status:
          type: string
        assigned_user:
          type: string
          nullable: true
        triggered_by:
          type: string
          enum: [automatic, manual, detection]
        success:
          type: boolean
        error_message:
          type: string
          nullable: true
        timestamp:
          type: string
          format: date-time

  securitySchemes:
    sessionCookie:
      type: apiKey
      in: cookie
      name: session_id

security:
  - sessionCookie: []

tags:
  - name: Chat
    description: Chat messaging endpoints
  - name: Workflow
    description: Issue creation and workflow automation
