openapi: 3.1.0
info:
  title: GitHub Project Workflow API — Agent Workflow Config UI
  description: |
    API changes for feature 004-agent-workflow-config-ui.
    Adds agent discovery endpoint, migrates agent_mappings from string arrays
    to AgentAssignment objects with UUID instance identity, and supports
    backward-compatible input (bare strings auto-promoted).
  version: 4.0.0

servers:
  - url: http://localhost:8000/api/v1
    description: Local development server

paths:
  /workflow/agents:
    get:
      summary: List available agents for a repository
      description: |
        Discovers agents available for assignment in the selected repository.
        Combines built-in agents (e.g., GitHub Copilot) with custom agents
        discovered from `.github/agents/*.agent.md` files via the GitHub
        Contents API.

        Returns 404 if no project is configured (no repository context).
        Returns an empty `agents` array with only built-in agents if the
        repository has no `.github/agents/` directory.
      operationId: listAvailableAgents
      tags:
        - Workflow
      parameters:
        - name: owner
          in: query
          required: false
          description: |
            Repository owner. Defaults to current workflow config's
            `repository_owner` if omitted.
          schema:
            type: string
        - name: repo
          in: query
          required: false
          description: |
            Repository name. Defaults to current workflow config's
            `repository_name` if omitted.
          schema:
            type: string
      responses:
        '200':
          description: List of available agents
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AvailableAgentsResponse'
              examples:
                with-custom-agents:
                  summary: Repository with custom agents
                  value:
                    agents:
                      - slug: copilot
                        display_name: GitHub Copilot
                        description: Default GitHub Copilot coding agent
                        avatar_url: null
                        source: builtin
                      - slug: speckit.specify
                        display_name: Spec Kit - Specify
                        description: Agent specializing in writing feature specifications
                        avatar_url: null
                        source: repository
                      - slug: speckit.plan
                        display_name: Spec Kit - Plan
                        description: Agent for generating implementation plans
                        avatar_url: null
                        source: repository
                no-custom-agents:
                  summary: Repository without custom agents
                  value:
                    agents:
                      - slug: copilot
                        display_name: GitHub Copilot
                        description: Default GitHub Copilot coding agent
                        avatar_url: null
                        source: builtin
        '404':
          description: No project configured (no repository context)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /workflow/config:
    get:
      summary: Get workflow configuration (MODIFIED)
      description: |
        Returns current workflow configuration. The `agent_mappings` field
        now returns `AgentAssignment` objects instead of bare strings.
        Each assignment has a UUID `id`, `slug`, optional `display_name`,
        and reserved `config` field.
      operationId: getWorkflowConfig
      tags:
        - Workflow
      responses:
        '200':
          description: Workflow configuration with typed agent assignments
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowConfiguration'
              example:
                project_id: PVT_kwHOABCDEF
                repository_owner: my-org
                repository_name: my-repo
                copilot_assignee: copilot-swe-agent[bot]
                review_assignee: null
                agent_mappings:
                  Backlog:
                    - id: 550e8400-e29b-41d4-a716-446655440001
                      slug: speckit.specify
                      display_name: Spec Kit - Specify
                      config: null
                  Ready:
                    - id: 550e8400-e29b-41d4-a716-446655440002
                      slug: speckit.plan
                      display_name: Spec Kit - Plan
                      config: null
                    - id: 550e8400-e29b-41d4-a716-446655440003
                      slug: speckit.tasks
                      display_name: Spec Kit - Tasks
                      config: null
                  In Progress:
                    - id: 550e8400-e29b-41d4-a716-446655440004
                      slug: speckit.implement
                      display_name: Spec Kit - Implement
                      config: null
                  In Review: []
                  Done: []
                status_backlog: Backlog
                status_ready: Ready
                status_in_progress: In Progress
                status_in_review: In Review
                enabled: true
        '404':
          description: No project selected

    put:
      summary: Update workflow configuration (MODIFIED)
      description: |
        Updates workflow configuration. The `agent_mappings` field accepts
        BOTH formats for backward compatibility:
        - New format: `[{"slug": "speckit.specify", "display_name": "..."}]`
        - Legacy format: `["speckit.specify"]` (bare strings auto-promoted)

        Server generates UUID `id` for any assignment without one.
        Returns the normalized configuration with all UUIDs populated.
      operationId: updateWorkflowConfig
      tags:
        - Workflow
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowConfiguration'
            examples:
              new-format:
                summary: New AgentAssignment format
                value:
                  project_id: PVT_kwHOABCDEF
                  repository_owner: my-org
                  repository_name: my-repo
                  copilot_assignee: ""
                  agent_mappings:
                    Backlog:
                      - slug: speckit.specify
                        display_name: Spec Kit - Specify
                    Ready:
                      - slug: copilot
                        display_name: GitHub Copilot
                    In Progress: []
                  enabled: true
              legacy-format:
                summary: Legacy bare string format (backward compatible)
                value:
                  project_id: PVT_kwHOABCDEF
                  repository_owner: my-org
                  repository_name: my-repo
                  copilot_assignee: ""
                  agent_mappings:
                    Backlog:
                      - speckit.specify
                    Ready:
                      - speckit.plan
                      - speckit.tasks
                  enabled: true
      responses:
        '200':
          description: Configuration saved successfully (returns normalized format)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowConfiguration'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    AgentAssignment:
      type: object
      required:
        - slug
      properties:
        id:
          type: string
          format: uuid
          description: Unique instance ID (server-generated if omitted)
          example: 550e8400-e29b-41d4-a716-446655440001
        slug:
          type: string
          description: Agent identifier slug
          pattern: '^[a-zA-Z0-9._-]+$'
          example: speckit.specify
        display_name:
          type: string
          nullable: true
          description: Human-readable display name
          example: Spec Kit - Specify
        config:
          type: object
          nullable: true
          description: Reserved for future per-assignment configuration
          additionalProperties: true

    AvailableAgent:
      type: object
      required:
        - slug
        - display_name
        - source
      properties:
        slug:
          type: string
          description: Unique agent identifier
          example: speckit.specify
        display_name:
          type: string
          description: Human-readable name
          example: Spec Kit - Specify
        description:
          type: string
          nullable: true
          description: Agent description/purpose
          example: Agent specializing in writing feature specifications
        avatar_url:
          type: string
          nullable: true
          format: uri
          description: Avatar image URL
        source:
          type: string
          enum:
            - builtin
            - repository
          description: Where the agent was discovered

    AvailableAgentsResponse:
      type: object
      required:
        - agents
      properties:
        agents:
          type: array
          items:
            $ref: '#/components/schemas/AvailableAgent'

    WorkflowConfiguration:
      type: object
      required:
        - project_id
        - repository_owner
        - repository_name
      properties:
        project_id:
          type: string
          description: GitHub Project node ID
        repository_owner:
          type: string
          description: Target repository owner
        repository_name:
          type: string
          description: Target repository name
        copilot_assignee:
          type: string
          default: ""
          description: Username for implementation assignment
        review_assignee:
          type: string
          nullable: true
          description: Username for review assignment
        agent_mappings:
          type: object
          description: |
            Status name → ordered list of agent assignments.
            Accepts both AgentAssignment objects and bare strings (backward compatible).
          additionalProperties:
            type: array
            items:
              oneOf:
                - $ref: '#/components/schemas/AgentAssignment'
                - type: string
                  description: Legacy bare slug string (auto-promoted to AgentAssignment)
        status_backlog:
          type: string
          default: Backlog
        status_ready:
          type: string
          default: Ready
        status_in_progress:
          type: string
          default: In Progress
        status_in_review:
          type: string
          default: In Review
        enabled:
          type: boolean
          default: true

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error message
        details:
          type: object
          additionalProperties: true
          description: Additional error context
