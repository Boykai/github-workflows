# Data Model: Profile Picture Upload

**Feature**: Profile Picture Upload  
**Date**: 2026-02-13  
**Status**: Complete

## Overview

This document defines the data entities, relationships, and state transitions for the profile picture upload feature. The design extends the existing UserSession model and introduces minimal new entities to maintain simplicity.

---

## Entities

### 1. UserSession (Extended)

**Description**: Existing model for authenticated user sessions, extended to include profile picture reference.

**Attributes**:

| Field | Type | Required | Description | Validation Rules |
|-------|------|----------|-------------|------------------|
| session_id | UUID | Yes | Unique session identifier | Generated by system |
| github_user_id | str | Yes | GitHub user ID from OAuth | Provided by GitHub |
| github_username | str | Yes | GitHub username for display | Provided by GitHub |
| github_avatar_url | str | No | User's GitHub avatar URL | Valid URL or null |
| **profile_picture_url** | **str** | **No** | **User's custom profile picture URL** | **Valid path or null** |
| access_token | str | Yes | Encrypted GitHub OAuth access token | Encrypted |
| refresh_token | str | No | Encrypted OAuth refresh token | Encrypted or null |
| token_expires_at | datetime | No | Token expiration timestamp | ISO 8601 format |
| selected_project_id | str | No | Currently selected GitHub Project ID | Valid project ID or null |
| created_at | datetime | Yes | Session creation time | ISO 8601, UTC |
| updated_at | datetime | Yes | Last activity time | ISO 8601, UTC |

**New Field Details**:
- `profile_picture_url`: Relative path to stored profile picture (e.g., `/storage/profile-pictures/{user_id}_{timestamp}.jpg`)
- Falls back to `github_avatar_url` if null
- Updated when user uploads or removes profile picture

---

### 2. ProfilePicture (New)

**Description**: Metadata about an uploaded profile picture. While the image file is stored on disk, this entity tracks upload metadata for audit and management purposes.

**Attributes**:

| Field | Type | Required | Description | Validation Rules |
|-------|------|----------|-------------|------------------|
| user_id | str | Yes | GitHub user ID of owner | Must match UserSession.github_user_id |
| filename | str | Yes | Server-generated filename | `{user_id}_{timestamp}.{ext}` |
| original_filename | str | Yes | User's original filename | Max 255 chars |
| file_path | str | Yes | Full path to stored file | `/backend/storage/profile-pictures/{filename}` |
| file_size | int | Yes | File size in bytes | Max 5,242,880 (5MB) |
| mime_type | str | Yes | Image MIME type | `image/jpeg` or `image/png` |
| width | int | Yes | Image width in pixels | Extracted by Pillow |
| height | int | Yes | Image height in pixels | Extracted by Pillow |
| uploaded_at | datetime | Yes | Upload timestamp | ISO 8601, UTC |

**Storage Location**:
- Physical files: `/backend/storage/profile-pictures/`
- Metadata: In-memory (MVP) or database (future)

**Lifecycle**:
1. **Created**: When user uploads a new profile picture
2. **Updated**: Never (immutable after creation)
3. **Deleted**: When user uploads a new picture (replaces old) or explicitly removes picture

---

## Relationships

```
UserSession 1 ──── 0..1 ProfilePicture
    │
    │ has
    │
    └─> profile_picture_url (reference)
```

**Relationship Details**:
- **One-to-Zero-or-One**: Each user session can have at most one profile picture
- **Cascade Delete**: Deleting a user session should also delete associated profile picture file
- **Replacement**: Uploading a new picture replaces the old one (old file is deleted)
- **Fallback**: If `profile_picture_url` is null, system uses `github_avatar_url`

---

## State Transitions

### Profile Picture State Machine

```
[No Picture] ──upload──> [Has Picture] ──remove──> [No Picture]
                              │
                              │ upload new
                              │
                              └──────────> [Has Picture] (replaces old)
```

**States**:

1. **No Picture** (`profile_picture_url` is null)
   - User has not uploaded a profile picture
   - System displays `github_avatar_url` or default avatar
   - Available actions: Upload

2. **Has Picture** (`profile_picture_url` is not null)
   - User has an active profile picture
   - System displays custom profile picture
   - Available actions: Upload (replace), Remove

**Transitions**:

| From State | Action | To State | Side Effects |
|-----------|--------|----------|--------------|
| No Picture | Upload | Has Picture | Save file, update `profile_picture_url` |
| Has Picture | Upload | Has Picture | Delete old file, save new file, update `profile_picture_url` |
| Has Picture | Remove | No Picture | Delete file, set `profile_picture_url` to null |

---

## Validation Rules

### Upload Validation

**Client-Side** (Frontend):
1. File format: JPEG or PNG (check file extension and MIME type)
2. File size: Maximum 5MB (5,242,880 bytes)
3. File selection: Only allow selecting files from file picker (no drag-drop in P1)

**Server-Side** (Backend - Critical):
1. **File format validation**: 
   - Check Content-Type header is `image/jpeg` or `image/png`
   - Use Pillow to verify file is a valid image (opens without error)
   - Verify image format matches claimed MIME type
   
2. **File size validation**:
   - Check Content-Length header ≤ 5MB
   - Verify actual file size after reading ≤ 5MB
   
3. **Image processing**:
   - Extract dimensions (width, height) using Pillow
   - Optionally re-encode image for security (strips EXIF, sanitizes)
   
4. **Filename generation**:
   - Server generates filename: `{github_user_id}_{timestamp}.{ext}`
   - Prevents path traversal attacks
   - Ensures uniqueness per user

5. **Storage validation**:
   - Ensure storage directory exists and is writable
   - Verify sufficient disk space (implementation-dependent)

### Display Validation

**Avatar Resolution Order**:
1. Check `profile_picture_url` → if exists and file exists, use it
2. Check `github_avatar_url` → if exists, use it
3. Use default avatar placeholder

**Error Handling**:
- If profile picture file is missing but `profile_picture_url` is set → log error, fall back to GitHub avatar
- If GitHub avatar fails to load → fall back to default avatar
- If default avatar fails → show initials or generic SVG icon

---

## Data Flow

### Upload Flow

```
[User] → [Frontend]
            │ 1. Select file
            │ 2. Client validation
            │ 3. Generate preview
            │ 4. User confirms
            │
            ├─> POST /api/v1/profile/picture
            │   └─> multipart/form-data with file
            │
        [Backend]
            │ 5. Authenticate user
            │ 6. Server validation
            │ 7. Process with Pillow
            │ 8. Generate filename
            │ 9. Save to storage
            │ 10. Update UserSession.profile_picture_url
            │ 11. Return success + URL
            │
        [Frontend]
            │ 12. Update local state
            │ 13. Display new avatar
            │ 14. Show success message
```

### Remove Flow

```
[User] → [Frontend]
            │ 1. Click remove
            │ 2. Confirm action
            │
            ├─> DELETE /api/v1/profile/picture
            │
        [Backend]
            │ 3. Authenticate user
            │ 4. Delete file from storage
            │ 5. Set UserSession.profile_picture_url = null
            │ 6. Return success
            │
        [Frontend]
            │ 7. Update local state
            │ 8. Display GitHub avatar or default
            │ 9. Show success message
```

### Display Flow

```
[Component] → Avatar Component
                 │ 1. Receive user object
                 │ 2. Check profile_picture_url
                 │ 3. If null, check github_avatar_url
                 │ 4. If null, use default avatar
                 │ 5. Render <img> with fallback onError handler
```

---

## Storage Schema

### File System Structure

```
/backend/storage/profile-pictures/
├── 12345678_1707840000.jpg    # User 12345678's picture
├── 87654321_1707841200.png    # User 87654321's picture
└── 12345678_1707842400.jpg    # User 12345678's updated picture (old one deleted)
```

**Naming Convention**: `{github_user_id}_{unix_timestamp}.{ext}`
- `github_user_id`: From UserSession.github_user_id
- `unix_timestamp`: Unix timestamp at upload time (ensures uniqueness)
- `ext`: File extension (`jpg` or `png`)

**Storage Properties**:
- Location: `/backend/storage/profile-pictures/`
- Permissions: Writable by backend service, readable by web server
- Retention: Keep only latest picture per user (delete old on upload/remove)
- Backup: Not included in MVP (files are in Docker volume)

---

## Edge Cases

### Storage Edge Cases

1. **Disk full**: Return 507 Insufficient Storage error, user can retry later
2. **Permission denied**: Log error, return 500 Internal Server Error
3. **Concurrent uploads**: Use user_id in filename to prevent conflicts; last upload wins
4. **Orphaned files**: If update fails after file save, cleanup in exception handler
5. **Missing storage directory**: Create on startup or first upload

### Display Edge Cases

1. **File deleted externally**: Fall back to GitHub avatar, log warning
2. **Corrupted file**: Handle Pillow errors during display, fall back to GitHub avatar
3. **Invalid URL in database**: Validate URL format, fall back if invalid
4. **Network issues loading avatar**: Browser's native img error handling shows broken image icon

### User Edge Cases

1. **Cancel during upload**: Frontend cancels request, backend cleans up temp file
2. **Multiple quick uploads**: Only latest completes (race condition acceptable)
3. **Upload same file twice**: Treated as new upload (new timestamp in filename)
4. **Upload very small image (1x1)**: Accepted if format and size are valid
5. **Upload very large dimension (10000x10000)**: Accepted if file size < 5MB

---

## Migration Notes

**Current State**:
- UserSession.github_avatar_url exists
- No profile_picture_url field yet

**Migration Steps**:
1. Add `profile_picture_url: str | None = None` to UserSession model
2. Update UserResponse to include profile_picture_url field
3. Update serialization to expose profile_picture_url in API responses
4. No data migration needed (new field defaults to null)

**Backward Compatibility**:
- Existing code that reads github_avatar_url is unaffected
- New Avatar component handles both old and new fields
- API clients can ignore profile_picture_url if not needed

---

## Summary

**New Fields**: 1 (profile_picture_url on UserSession)  
**New Entities**: 1 (ProfilePicture metadata)  
**New Relationships**: 1 (UserSession 1:0..1 ProfilePicture)  
**State Transitions**: 3 (Upload, Replace, Remove)  
**Validation Layers**: 2 (Client + Server)

This design minimizes complexity by extending existing models and leveraging the current in-memory storage pattern. The ProfilePicture entity is primarily for documentation; the MVP can track metadata in-memory or omit it entirely, storing only the file and updating the UserSession reference.
