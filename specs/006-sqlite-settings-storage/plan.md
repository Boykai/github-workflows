# Implementation Plan: SQLite-Backed Settings Storage

**Branch**: `006-sqlite-settings-storage` | **Date**: 2026-02-19 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/006-sqlite-settings-storage/spec.md`

## Summary

Add an SQLite database (via aiosqlite) as the durable persistence layer for user sessions, user preferences, project-level settings, and global/instance-level settings. Replace the current volatile in-memory dict-based session storage in `github_auth.py` with database-backed persistence. Keep the existing `InMemoryCache` for short-lived transient data (API response caching). Add a frontend Settings page as a new `activeView` alongside Chat and Project Board. Provide REST endpoints that return merged settings views (global → user → project). Include schema versioning via an embedded `schema_version` table with numbered migration scripts run at startup.

## Technical Context

**Language/Version**: Python 3.12 (Dockerfile), ≥3.11 (pyproject.toml); TypeScript ~5.4 (frontend)
**Primary Dependencies**: FastAPI 0.109+, Pydantic 2.5+, pydantic-settings 2.1+, React 18.3, TanStack Query 5.17+
**New Dependencies**: aiosqlite (async SQLite), no ORM (raw queries with Pydantic models for serialization)
**Storage**: SQLite database file, Docker volume mount (new)
**Testing**: pytest 7.4+, pytest-asyncio 0.23+, vitest 4.0+
**Target Platform**: Linux Docker containers (amd64), browser (Chrome/Firefox/Safari)
**Project Type**: Web application (backend + frontend)
**Performance Goals**: Settings API responses < 500ms (SC-003); database init < 2s on first startup
**Constraints**: Async-only database access (no blocking the FastAPI event loop); SQLite single-writer concurrency model
**Scale/Scope**: Single-instance deployment; tens of concurrent users; < 10k settings rows total

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Pre-Design | Post-Design |
|-----------|--------|------------|-------------|
| I. Specification-First | **PASS** | spec.md complete with 10 prioritized user stories, acceptance scenarios, 43 FRs | Unchanged. All design artifacts trace back to spec FRs |
| II. Template-Driven Workflow | **PASS** | Using canonical plan template; all artifacts follow `.specify/templates/` | All Phase 0/1 artifacts produced per template structure |
| III. Agent-Orchestrated Execution | **PASS** | Plan generated by `/speckit.plan` agent with clear input (spec.md) | Phase 0 research dispatched to sub-agent; Phase 1 artifacts generated sequentially. Agent context updated |
| IV. Test Optionality | **PASS** | No explicit test mandate in spec | Data model and contracts designed to be test-friendly. Tests deferred to tasks phase |
| V. Simplicity and DRY | **PASS** | Using raw aiosqlite + Pydantic instead of full ORM | 5 tables, 6 endpoints, merged settings view via Python dict merge — no over-engineering |

No violations. Complexity Tracking section not needed.

## Project Structure

### Documentation (this feature)

```text
specs/006-sqlite-settings-storage/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output (OpenAPI schemas)
│   └── settings-api.yaml
└── tasks.md             # Phase 2 output (/speckit.tasks command)
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── api/
│   │   ├── __init__.py          # MODIFIED: Add settings router
│   │   └── settings.py          # NEW: Settings API endpoints
│   ├── models/
│   │   ├── user.py              # Existing UserSession model
│   │   └── settings.py          # NEW: Settings Pydantic models
│   ├── services/
│   │   ├── cache.py             # Existing InMemoryCache (unchanged)
│   │   ├── database.py          # NEW: SQLite connection, init, migrations
│   │   ├── session_store.py     # NEW: DB-backed session CRUD
│   │   ├── settings_store.py    # NEW: DB-backed settings CRUD + merging
│   │   └── github_auth.py       # MODIFIED: Replace _sessions dict with session_store
│   ├── migrations/              # NEW: Numbered SQL migration scripts
│   │   ├── __init__.py
│   │   └── 001_initial_schema.sql
│   ├── config.py                # MODIFIED: Add database_path setting
│   ├── constants.py             # MODIFIED: Add notification event type constants
│   └── main.py                  # MODIFIED: Init DB in lifespan, start cleanup task
└── tests/

frontend/
├── src/
│   ├── components/
│   │   └── settings/            # NEW: Settings UI components
│   │       ├── SettingsSection.tsx
│   │       ├── AIPreferences.tsx
│   │       ├── DisplayPreferences.tsx
│   │       ├── WorkflowDefaults.tsx
│   │       ├── NotificationPreferences.tsx
│   │       ├── ProjectSettings.tsx
│   │       └── GlobalSettings.tsx
│   ├── hooks/
│   │   ├── useSettings.ts       # NEW: Settings data fetching hook
│   │   └── useAppTheme.ts       # MODIFIED: Integrate with settings API
│   ├── pages/
│   │   └── SettingsPage.tsx     # NEW: Settings page layout
│   ├── services/
│   │   └── api.ts               # MODIFIED: Add settingsApi methods
│   ├── types/
│   │   └── index.ts             # MODIFIED: Add Settings types
│   └── App.tsx                  # MODIFIED: Add 'settings' to activeView, nav link
└── tests/

docker-compose.yml               # MODIFIED: Add named volume for SQLite DB
```

**Structure Decision**: Web application. Follows existing `backend/src/` and `frontend/src/` convention. New files are placed in the established module directories (api/, models/, services/, components/, hooks/, pages/). A new `migrations/` directory is added under `backend/src/` for SQL migration scripts.

## Complexity Tracking

> No violations detected. No complexity justifications needed.
