openapi: "3.1.0"
info:
  title: Settings API
  description: |
    REST endpoints for managing user preferences, project-level settings,
    and global/instance-level settings. All endpoints require authentication
    via session cookie.
  version: "1.0.0"

paths:
  /api/v1/settings/user:
    get:
      operationId: getUserSettings
      summary: Get authenticated user's effective settings
      description: |
        Returns the merged/effective settings for the authenticated user.
        Global defaults are used for any field the user has not overridden.
        The response always contains fully-resolved values (no nulls).
      tags: [settings]
      security:
        - sessionCookie: []
      responses:
        "200":
          description: Effective user settings (merged with global defaults)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EffectiveUserSettings"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    put:
      operationId: updateUserSettings
      summary: Update authenticated user's preferences
      description: |
        Partial update — only the fields provided in the request body are
        updated. Fields not included are left unchanged. To reset a field
        to the global default, set it to null explicitly.
      tags: [settings]
      security:
        - sessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserPreferencesUpdate"
      responses:
        "200":
          description: Updated effective user settings
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EffectiveUserSettings"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/settings/global:
    get:
      operationId: getGlobalSettings
      summary: Get global/instance-level settings
      description: |
        Returns the current global settings. These serve as defaults for
        all users who have not overridden specific preferences.
      tags: [settings]
      security:
        - sessionCookie: []
      responses:
        "200":
          description: Global settings
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GlobalSettings"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    put:
      operationId: updateGlobalSettings
      summary: Update global/instance-level settings
      description: |
        Partial update — only the fields provided are updated. Any
        authenticated user can modify global settings (no RBAC in this version).
      tags: [settings]
      security:
        - sessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GlobalSettingsUpdate"
      responses:
        "200":
          description: Updated global settings
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GlobalSettings"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/settings/project/{project_id}:
    get:
      operationId: getProjectSettings
      summary: Get per-project settings for authenticated user
      description: |
        Returns the effective settings for a specific project, merged with
        user preferences and global defaults. Merge order:
        project_settings > user_preferences > global_settings.
      tags: [settings]
      security:
        - sessionCookie: []
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: string
          description: GitHub Project ID (e.g., "PVT_kwDOABCD1234")
      responses:
        "200":
          description: Effective project settings
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EffectiveProjectSettings"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    put:
      operationId: updateProjectSettings
      summary: Update per-project settings for authenticated user
      description: |
        Partial update — only the fields provided are updated. Fields not
        included are left unchanged. To reset a field, set it to null.
      tags: [settings]
      security:
        - sessionCookie: []
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: string
          description: GitHub Project ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProjectSettingsUpdate"
      responses:
        "200":
          description: Updated effective project settings
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EffectiveProjectSettings"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  securitySchemes:
    sessionCookie:
      type: apiKey
      in: cookie
      name: session_id

  schemas:
    # ── Enums ──

    AIProvider:
      type: string
      enum: [copilot, azure_openai]

    ThemeMode:
      type: string
      enum: [dark, light]

    DefaultView:
      type: string
      enum: [chat, board, settings]

    NotificationEventType:
      type: string
      enum: [task_status_change, agent_completion, new_recommendation, chat_mention]

    # ── AI Preferences ──

    AIPreferences:
      type: object
      description: AI-related settings (fully resolved, no nulls)
      required: [provider, model, temperature]
      properties:
        provider:
          $ref: "#/components/schemas/AIProvider"
        model:
          type: string
          example: "gpt-4o"
        temperature:
          type: number
          format: float
          minimum: 0.0
          maximum: 2.0
          example: 0.7

    # ── Display Preferences ──

    DisplayPreferences:
      type: object
      description: UI/display settings (fully resolved, no nulls)
      required: [theme, default_view, sidebar_collapsed]
      properties:
        theme:
          $ref: "#/components/schemas/ThemeMode"
        default_view:
          $ref: "#/components/schemas/DefaultView"
        sidebar_collapsed:
          type: boolean

    # ── Workflow Defaults ──

    WorkflowDefaults:
      type: object
      description: Workflow configuration (fully resolved)
      required: [default_repository, default_assignee, copilot_polling_interval]
      properties:
        default_repository:
          type: string
          nullable: true
          example: "owner/repo"
        default_assignee:
          type: string
          example: ""
        copilot_polling_interval:
          type: integer
          minimum: 0
          example: 60

    # ── Notification Preferences ──

    NotificationPreferences:
      type: object
      description: Per-event notification toggles (fully resolved)
      required:
        - task_status_change
        - agent_completion
        - new_recommendation
        - chat_mention
      properties:
        task_status_change:
          type: boolean
        agent_completion:
          type: boolean
        new_recommendation:
          type: boolean
        chat_mention:
          type: boolean

    # ── Effective User Settings (GET response) ──

    EffectiveUserSettings:
      type: object
      description: |
        Fully resolved user settings. All fields are non-null.
        Computed as: global_settings merged with user_preferences.
      required: [ai, display, workflow, notifications]
      properties:
        ai:
          $ref: "#/components/schemas/AIPreferences"
        display:
          $ref: "#/components/schemas/DisplayPreferences"
        workflow:
          $ref: "#/components/schemas/WorkflowDefaults"
        notifications:
          $ref: "#/components/schemas/NotificationPreferences"

    # ── User Preferences Update (PUT request) ──

    UserPreferencesUpdate:
      type: object
      description: |
        Partial update payload. All fields are optional.
        Set a field to null to reset it to the global default.
      properties:
        ai:
          type: object
          properties:
            provider:
              $ref: "#/components/schemas/AIProvider"
            model:
              type: string
              nullable: true
            temperature:
              type: number
              format: float
              minimum: 0.0
              maximum: 2.0
              nullable: true
        display:
          type: object
          properties:
            theme:
              $ref: "#/components/schemas/ThemeMode"
            default_view:
              $ref: "#/components/schemas/DefaultView"
            sidebar_collapsed:
              type: boolean
              nullable: true
        workflow:
          type: object
          properties:
            default_repository:
              type: string
              nullable: true
            default_assignee:
              type: string
              nullable: true
            copilot_polling_interval:
              type: integer
              minimum: 0
              nullable: true
        notifications:
          type: object
          properties:
            task_status_change:
              type: boolean
              nullable: true
            agent_completion:
              type: boolean
              nullable: true
            new_recommendation:
              type: boolean
              nullable: true
            chat_mention:
              type: boolean
              nullable: true

    # ── Global Settings (GET response) ──

    GlobalSettings:
      type: object
      description: Instance-wide default settings. All fields are non-null.
      required: [ai, display, workflow, notifications, allowed_models]
      properties:
        ai:
          $ref: "#/components/schemas/AIPreferences"
        display:
          $ref: "#/components/schemas/DisplayPreferences"
        workflow:
          $ref: "#/components/schemas/WorkflowDefaults"
        notifications:
          $ref: "#/components/schemas/NotificationPreferences"
        allowed_models:
          type: array
          items:
            type: string
          description: List of allowed model identifiers
          example: ["gpt-4o", "gpt-4"]

    # ── Global Settings Update (PUT request) ──

    GlobalSettingsUpdate:
      type: object
      description: Partial update for global settings.
      properties:
        ai:
          type: object
          properties:
            provider:
              $ref: "#/components/schemas/AIProvider"
            model:
              type: string
            temperature:
              type: number
              format: float
              minimum: 0.0
              maximum: 2.0
        display:
          type: object
          properties:
            theme:
              $ref: "#/components/schemas/ThemeMode"
            default_view:
              $ref: "#/components/schemas/DefaultView"
            sidebar_collapsed:
              type: boolean
        workflow:
          type: object
          properties:
            default_repository:
              type: string
              nullable: true
            default_assignee:
              type: string
            copilot_polling_interval:
              type: integer
              minimum: 0
        notifications:
          type: object
          properties:
            task_status_change:
              type: boolean
            agent_completion:
              type: boolean
            new_recommendation:
              type: boolean
            chat_mention:
              type: boolean
        allowed_models:
          type: array
          items:
            type: string

    # ── Project Settings ──

    ProjectBoardConfig:
      type: object
      description: Board display configuration for a project
      properties:
        column_order:
          type: array
          items:
            type: string
          example: ["Backlog", "Ready", "In Progress", "Done"]
        collapsed_columns:
          type: array
          items:
            type: string
          example: ["Done"]
        show_estimates:
          type: boolean
          example: true

    ProjectAgentMapping:
      type: object
      description: Agent assignment for a pipeline status
      required: [slug]
      properties:
        slug:
          type: string
          example: "speckit.specify"
        display_name:
          type: string
          nullable: true
          example: "Spec Kit - Specify"

    EffectiveProjectSettings:
      type: object
      description: |
        Fully resolved project settings.
        Includes user + global effective settings plus project-specific overrides.
      required: [ai, display, workflow, notifications, project]
      properties:
        ai:
          $ref: "#/components/schemas/AIPreferences"
        display:
          $ref: "#/components/schemas/DisplayPreferences"
        workflow:
          $ref: "#/components/schemas/WorkflowDefaults"
        notifications:
          $ref: "#/components/schemas/NotificationPreferences"
        project:
          type: object
          required: [project_id]
          properties:
            project_id:
              type: string
              example: "PVT_kwDOABCD1234"
            board_display_config:
              $ref: "#/components/schemas/ProjectBoardConfig"
            agent_pipeline_mappings:
              type: object
              additionalProperties:
                type: array
                items:
                  $ref: "#/components/schemas/ProjectAgentMapping"
              example:
                Backlog:
                  - slug: "speckit.specify"
                    display_name: "Spec Kit - Specify"

    ProjectSettingsUpdate:
      type: object
      description: Partial update for project-specific settings.
      properties:
        board_display_config:
          $ref: "#/components/schemas/ProjectBoardConfig"
        agent_pipeline_mappings:
          type: object
          nullable: true
          additionalProperties:
            type: array
            items:
              $ref: "#/components/schemas/ProjectAgentMapping"

    # ── Error Response ──

    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string
          description: Human-readable error message
        details:
          type: object
          additionalProperties: true
          description: Optional additional error context
