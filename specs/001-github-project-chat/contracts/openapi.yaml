openapi: 3.0.3
info:
  title: GitHub Projects Chat API
  description: |
    REST API for the GitHub Projects Chat Interface.
    Enables natural language task management for GitHub Projects V2.
  version: 1.0.0
  contact:
    name: API Support

servers:
  - url: http://localhost:8000/api/v1
    description: Development server
  - url: https://api.example.com/api/v1
    description: Production server

tags:
  - name: auth
    description: GitHub OAuth authentication
  - name: projects
    description: GitHub Projects management
  - name: tasks
    description: Task CRUD operations
  - name: chat
    description: AI-powered chat interface

paths:
  # ============ AUTH ENDPOINTS ============
  /auth/github:
    get:
      tags: [auth]
      summary: Initiate GitHub OAuth flow
      description: Redirects user to GitHub authorization page
      operationId: initiateGitHubOAuth
      responses:
        '302':
          description: Redirect to GitHub OAuth
          headers:
            Location:
              schema:
                type: string
                example: https://github.com/login/oauth/authorize?client_id=xxx

  /auth/github/callback:
    get:
      tags: [auth]
      summary: GitHub OAuth callback
      description: Handles OAuth callback, exchanges code for token
      operationId: handleGitHubCallback
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
        - name: state
          in: query
          required: true
          schema:
            type: string
      responses:
        '302':
          description: Redirect to frontend with session
        '400':
          $ref: '#/components/responses/BadRequest'

  /auth/me:
    get:
      tags: [auth]
      summary: Get current user
      description: Returns authenticated user information
      operationId: getCurrentUser
      security:
        - sessionCookie: []
      responses:
        '200':
          description: Current user info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/logout:
    post:
      tags: [auth]
      summary: Logout user
      description: Invalidates the current session
      operationId: logout
      security:
        - sessionCookie: []
      responses:
        '200':
          description: Successfully logged out
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out successfully

  # ============ PROJECTS ENDPOINTS ============
  /projects:
    get:
      tags: [projects]
      summary: List user's GitHub Projects
      description: Returns all projects accessible to the authenticated user
      operationId: listProjects
      security:
        - sessionCookie: []
      parameters:
        - name: refresh
          in: query
          description: Force refresh from GitHub API (bypass cache)
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: List of projects
          content:
            application/json:
              schema:
                type: object
                properties:
                  projects:
                    type: array
                    items:
                      $ref: '#/components/schemas/Project'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /projects/{projectId}:
    get:
      tags: [projects]
      summary: Get project details
      description: Returns detailed project information including items
      operationId: getProject
      security:
        - sessionCookie: []
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
            example: PVT_kwDOABCD1234
      responses:
        '200':
          description: Project details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /projects/select:
    post:
      tags: [projects]
      summary: Select active project
      description: Sets the currently active project for the user session
      operationId: selectProject
      security:
        - sessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [project_id]
              properties:
                project_id:
                  type: string
                  example: PVT_kwDOABCD1234
      responses:
        '200':
          description: Project selected successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectDetail'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ============ TASKS ENDPOINTS ============
  /tasks:
    get:
      tags: [tasks]
      summary: List tasks in selected project
      description: Returns all tasks in the currently selected project
      operationId: listTasks
      security:
        - sessionCookie: []
      parameters:
        - name: status
          in: query
          description: Filter by status column
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
        - name: cursor
          in: query
          description: Pagination cursor
          schema:
            type: string
      responses:
        '200':
          description: List of tasks
          content:
            application/json:
              schema:
                type: object
                properties:
                  tasks:
                    type: array
                    items:
                      $ref: '#/components/schemas/Task'
                  next_cursor:
                    type: string
                    nullable: true
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags: [tasks]
      summary: Create task from confirmed proposal
      description: Creates a task in GitHub Project from a confirmed AI proposal
      operationId: createTask
      security:
        - sessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskCreateRequest'
      responses:
        '201':
          description: Task created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /tasks/{taskId}:
    get:
      tags: [tasks]
      summary: Get task details
      operationId: getTask
      security:
        - sessionCookie: []
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Task details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '404':
          $ref: '#/components/responses/NotFound'

  /tasks/{taskId}/status:
    patch:
      tags: [tasks]
      summary: Update task status
      description: Changes the status of a task in GitHub Project
      operationId: updateTaskStatus
      security:
        - sessionCookie: []
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  type: string
                  description: Target status column name
                  example: In Progress
      responses:
        '200':
          description: Status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  # ============ CHAT ENDPOINTS ============
  /chat/messages:
    get:
      tags: [chat]
      summary: Get chat history
      description: Returns recent chat messages for the session
      operationId: getChatHistory
      security:
        - sessionCookie: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
      responses:
        '200':
          description: Chat history
          content:
            application/json:
              schema:
                type: object
                properties:
                  messages:
                    type: array
                    items:
                      $ref: '#/components/schemas/ChatMessage'

    post:
      tags: [chat]
      summary: Send chat message
      description: Sends user message and receives AI response
      operationId: sendChatMessage
      security:
        - sessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                content:
                  type: string
                  maxLength: 10000
                  example: Create a task to implement user authentication
      responses:
        '200':
          description: AI response with optional task proposal
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /chat/proposals/{proposalId}/confirm:
    post:
      tags: [chat]
      summary: Confirm task proposal
      description: Confirms an AI-generated task proposal for creation
      operationId: confirmProposal
      security:
        - sessionCookie: []
      parameters:
        - name: proposalId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                edited_title:
                  type: string
                  maxLength: 256
                edited_description:
                  type: string
                  maxLength: 65535
      responses:
        '201':
          description: Task created from proposal
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '410':
          description: Proposal expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /chat/proposals/{proposalId}/cancel:
    post:
      tags: [chat]
      summary: Cancel task proposal
      operationId: cancelProposal
      security:
        - sessionCookie: []
      parameters:
        - name: proposalId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Proposal cancelled
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Proposal cancelled

components:
  securitySchemes:
    sessionCookie:
      type: apiKey
      in: cookie
      name: session_id

  schemas:
    User:
      type: object
      properties:
        github_user_id:
          type: string
        github_username:
          type: string
        github_avatar_url:
          type: string
          nullable: true
        selected_project_id:
          type: string
          nullable: true

    Project:
      type: object
      properties:
        project_id:
          type: string
          example: PVT_kwDOABCD1234
        name:
          type: string
          example: Sprint 42
        type:
          type: string
          enum: [organization, user, repository]
        owner_login:
          type: string
          example: acme-corp
        url:
          type: string
          format: uri
        item_count:
          type: integer
        status_columns:
          type: array
          items:
            $ref: '#/components/schemas/StatusColumn'

    ProjectDetail:
      allOf:
        - $ref: '#/components/schemas/Project'
        - type: object
          properties:
            description:
              type: string
              nullable: true
            tasks:
              type: array
              items:
                $ref: '#/components/schemas/Task'

    StatusColumn:
      type: object
      properties:
        field_id:
          type: string
        name:
          type: string
          example: Todo
        option_id:
          type: string
        color:
          type: string
          nullable: true

    Task:
      type: object
      properties:
        task_id:
          type: string
          format: uuid
        project_id:
          type: string
        github_item_id:
          type: string
        title:
          type: string
          maxLength: 256
        description:
          type: string
          nullable: true
          maxLength: 65535
        status:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    TaskCreateRequest:
      type: object
      required: [proposal_id]
      properties:
        proposal_id:
          type: string
          format: uuid
          description: ID of confirmed AI proposal
        edited_title:
          type: string
          maxLength: 256
        edited_description:
          type: string
          maxLength: 65535

    ChatMessage:
      type: object
      properties:
        message_id:
          type: string
          format: uuid
        sender_type:
          type: string
          enum: [user, assistant, system]
        content:
          type: string
        action_type:
          type: string
          enum: [task_create, status_update, project_select]
          nullable: true
        action_data:
          type: object
          nullable: true
        timestamp:
          type: string
          format: date-time

    ChatResponse:
      type: object
      properties:
        message:
          $ref: '#/components/schemas/ChatMessage'
        proposal:
          $ref: '#/components/schemas/TaskProposal'
          nullable: true

    TaskProposal:
      type: object
      properties:
        proposal_id:
          type: string
          format: uuid
        original_input:
          type: string
        proposed_title:
          type: string
        proposed_description:
          type: string
        status:
          type: string
          enum: [pending, confirmed, edited, cancelled]
        expires_at:
          type: string
          format: date-time

    Error:
      type: object
      properties:
        error:
          type: string
        detail:
          type: string
        code:
          type: string

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Bad Request
            detail: Invalid project_id format
            code: INVALID_PROJECT_ID

    Unauthorized:
      description: Not authenticated
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Unauthorized
            detail: Session expired or invalid
            code: UNAUTHORIZED

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Not Found
            detail: Task not found
            code: NOT_FOUND
