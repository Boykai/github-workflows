openapi: 3.1.0
info:
  title: GitHub Project Workflow API — Spec Kit Agent Assignment
  description: |
    API changes for feature 002-speckit-agent-assignment.
    Extends the existing workflow API to support per-status Spec Kit custom agent mappings,
    pipeline state tracking, and agent completion polling.
  version: 2.0.0

servers:
  - url: http://localhost:8000/api/v1
    description: Local development server

paths:
  /workflow/recommendations/{recommendation_id}/confirm:
    post:
      summary: Confirm issue recommendation (MODIFIED)
      description: |
        Confirms an AI-generated issue recommendation. CHANGED behavior:
        1. GitHub Issue creation (REST API) — unchanged
        2. Project attachment (GraphQL API) — unchanged
        3. Initial status set to "Backlog" — unchanged
        4. **NEW**: Assign `speckit.specify` agent (from agent_mappings["Backlog"])
        5. **REMOVED**: No longer auto-transitions to "Ready" — issue stays in Backlog
           until `speckit.specify` completes (detected by polling service)
      operationId: confirmRecommendation
      tags:
        - Workflow
      parameters:
        - name: recommendation_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Issue created and Backlog agent assigned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowResult'
        '404':
          description: Recommendation not found
        '409':
          description: Recommendation already processed
        '500':
          description: GitHub API error

  /workflow/config:
    get:
      summary: Get workflow configuration (MODIFIED)
      description: |
        Returns current workflow configuration including the new `agent_mappings` field.
        The deprecated `custom_agent` field is removed.
      operationId: getWorkflowConfig
      tags:
        - Workflow
      responses:
        '200':
          description: Workflow configuration with agent mappings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowConfiguration'
        '404':
          description: No project selected

    put:
      summary: Update workflow configuration (MODIFIED)
      description: |
        Updates workflow configuration. Now accepts `agent_mappings` to configure
        which Spec Kit agents run at each status.
      operationId: updateWorkflowConfig
      tags:
        - Workflow
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowConfigurationUpdate'
      responses:
        '200':
          description: Configuration updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowConfiguration'
        '400':
          description: Invalid configuration

  /workflow/pipeline-states:
    get:
      summary: Get pipeline states (NEW)
      description: |
        Returns the current pipeline state for all tracked issues.
        Shows which agent is active and which have completed for each issue
        currently in the agent pipeline.
      operationId: getPipelineStates
      tags:
        - Workflow
      responses:
        '200':
          description: List of pipeline states
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PipelineState'

  /workflow/pipeline-states/{issue_number}:
    get:
      summary: Get pipeline state for issue (NEW)
      description: |
        Returns the pipeline state for a specific issue.
        Includes current agent, completed agents, and pipeline status.
      operationId: getPipelineState
      tags:
        - Workflow
      parameters:
        - name: issue_number
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Pipeline state for the issue
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PipelineState'
        '404':
          description: No pipeline state found for this issue

  /workflow/polling/check-all:
    post:
      summary: Check all issues for agent completion (MODIFIED)
      description: |
        Triggers a manual poll cycle. CHANGED behavior:
        Now checks Backlog issues for `speckit.specify` completion,
        Ready issues for `speckit.plan`/`speckit.tasks` completion,
        and In Progress issues for PR-based completion (existing).
      operationId: checkAllIssues
      tags:
        - Workflow
      responses:
        '200':
          description: Poll results for all statuses
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PollResult'

  /workflow/polling/check-issue/{issue_number}:
    post:
      summary: Check single issue for agent completion (MODIFIED)
      description: |
        Triggers a manual completion check for a specific issue.
        Detects comment-based completion for Backlog/Ready agents
        and PR-based completion for In Progress agents.
      operationId: checkIssue
      tags:
        - Workflow
      parameters:
        - name: issue_number
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Completion check result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IssueCheckResult'

components:
  schemas:
    WorkflowResult:
      type: object
      properties:
        success:
          type: boolean
        issue_id:
          type: string
          description: GitHub Issue node ID
        issue_number:
          type: integer
          description: Human-readable issue number
        issue_url:
          type: string
          format: uri
        project_item_id:
          type: string
          description: GitHub Project item ID
        current_status:
          type: string
          example: "Backlog"
          description: "CHANGED: Now 'Backlog' instead of 'Ready' — issue waits for agent"
        assigned_agent:
          type: string
          nullable: true
          example: "speckit.specify"
          description: "NEW: The agent assigned at this status"
        message:
          type: string
          example: "Issue #42 created, added to project in Backlog, speckit.specify assigned"

    WorkflowConfiguration:
      type: object
      properties:
        project_id:
          type: string
        repository_owner:
          type: string
        repository_name:
          type: string
        copilot_assignee:
          type: string
          default: ""
          description: Fallback assignee when agent assignment fails
        review_assignee:
          type: string
          nullable: true
          description: Reviewer for In Review status
        agent_mappings:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          default:
            Backlog: ["speckit.specify"]
            Ready: ["speckit.plan", "speckit.tasks"]
            In Progress: ["speckit.implement"]
          description: |
            NEW: Maps workflow status names to ordered lists of Spec Kit agent names.
            Replaces the removed `custom_agent` field.
          example:
            Backlog: ["speckit.specify"]
            Ready: ["speckit.plan", "speckit.tasks"]
            In Progress: ["speckit.implement"]
        status_backlog:
          type: string
          default: "Backlog"
        status_ready:
          type: string
          default: "Ready"
        status_in_progress:
          type: string
          default: "In Progress"
        status_in_review:
          type: string
          default: "In Review"
        enabled:
          type: boolean
          default: true

    WorkflowConfigurationUpdate:
      type: object
      properties:
        copilot_assignee:
          type: string
        review_assignee:
          type: string
        agent_mappings:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: "NEW: Update status-to-agent mappings"
        status_backlog:
          type: string
        status_ready:
          type: string
        status_in_progress:
          type: string
        status_in_review:
          type: string
        enabled:
          type: boolean

    PipelineState:
      type: object
      description: "NEW: Tracks per-issue pipeline progress through sequential agents"
      properties:
        issue_number:
          type: integer
          description: GitHub issue number
        project_id:
          type: string
          description: GitHub Project V2 node ID
        status:
          type: string
          description: Current workflow status
          example: "Ready"
        agents:
          type: array
          items:
            type: string
          description: Ordered list of agents for this status
          example: ["speckit.plan", "speckit.tasks"]
        current_agent:
          type: string
          nullable: true
          description: Currently active agent name
          example: "speckit.plan"
        current_agent_index:
          type: integer
          description: Index of current agent in the agents list
          example: 0
        completed_agents:
          type: array
          items:
            type: string
          description: Agents that have posted completion markers
          example: []
        is_complete:
          type: boolean
          description: Whether all agents in the pipeline have completed
          example: false
        started_at:
          type: string
          format: date-time
          nullable: true
          description: When the current agent was assigned
        error:
          type: string
          nullable: true
          description: Last error message, if any

    PollResult:
      type: object
      description: "MODIFIED: Now includes results for all status checks"
      properties:
        backlog_checked:
          type: integer
          description: "NEW: Number of Backlog issues checked"
        backlog_completed:
          type: integer
          description: "NEW: Number of Backlog issues where agent completed"
        ready_checked:
          type: integer
          description: "NEW: Number of Ready issues checked"
        ready_advanced:
          type: integer
          description: "NEW: Number of Ready issues where pipeline advanced"
        in_progress_checked:
          type: integer
          description: Number of In Progress issues checked
        in_progress_completed:
          type: integer
          description: Number of In Progress issues where PR completed
        in_review_checked:
          type: integer
          description: Number of In Review issues checked
        timestamp:
          type: string
          format: date-time

    IssueCheckResult:
      type: object
      description: "MODIFIED: Includes agent completion details"
      properties:
        issue_number:
          type: integer
        status:
          type: string
        agent_completed:
          type: boolean
          description: Whether an agent completion was detected
        completed_agent:
          type: string
          nullable: true
          description: Name of the agent that completed
        next_action:
          type: string
          nullable: true
          description: What happens next (e.g., "assign speckit.tasks", "transition to In Progress")
          example: "assign speckit.tasks"

    AgentNotification:
      type: object
      description: "NEW: WebSocket notification for agent events"
      properties:
        type:
          type: string
          enum: [agent_assigned, agent_completed]
        issue_number:
          type: integer
        agent_name:
          type: string
          example: "speckit.plan"
        status:
          type: string
          example: "Ready"
        next_agent:
          type: string
          nullable: true
          description: Next agent in pipeline, or null if pipeline complete
        timestamp:
          type: string
          format: date-time

  securitySchemes:
    sessionCookie:
      type: apiKey
      in: cookie
      name: session_id

security:
  - sessionCookie: []

tags:
  - name: Workflow
    description: Issue creation, agent assignment, and pipeline management
